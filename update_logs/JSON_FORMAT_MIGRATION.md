# JSON格式响应迁移说明

## 概述

本次更新将对话模型的响应格式从【】标记格式迁移到JSON格式，以提供更好的结构化数据处理和更稳定的表情变化控制。

## 变更内容

### 1. 响应格式变更

**原格式（【】标记）：**
```
你好！【1】我很高兴见到你！【2】今天天气真不错呢~【3】
```

**新格式（JSON）：**
```json
{
  "mood": 1,
  "content": "你好！我很高兴见到你！今天天气真不错呢~"
}
```

### 2. 处理逻辑变更

#### 后端变更（app.py）
- 修改 `/api/chat/stream` 端点以解析JSON格式响应
- 一旦接收到完整的 `mood` 字段，立即转发给前端处理表情变化
- 将 `content` 字段的内容转发给前端进行流式显示
- 历史记录和记忆库存储原始JSON响应内容

#### 前端变更（main.js, stream_processor.js）
- 移除【】内容的检测和处理逻辑
- 添加 `handleMoodChange()` 函数处理JSON格式的mood字段
- 修改流式处理器，移除【】相关的状态和回调
- 更新消息显示和历史记录处理，不再过滤【】内容

### 3. 配置变更

#### config.py
- 更新系统提示词以要求JSON格式输出
- 标记 `clean_assistant_history` 配置为已弃用

#### utils/history_utils.py
- 移除【】内容清理逻辑
- 直接存储原始响应内容

## 优势

1. **更稳定的表情控制**：mood字段独立处理，避免了【】标记可能被截断的问题
2. **更好的数据结构**：JSON格式提供了清晰的数据结构，便于扩展
3. **并行处理**：mood和content可以并行处理，提高响应速度
4. **简化前端逻辑**：移除了复杂的【】内容检测和过滤逻辑

## 兼容性

- 保留了原有的表情处理函数 `handleExtractedBracketContents()` 以确保兼容性
- `clean_assistant_history` 配置保留但标记为已弃用
- 历史记录格式保持不变，只是内容从过滤后的文本变为原始JSON

## 测试

运行 `python test_json_format.py` 来测试新的JSON解析逻辑和mood处理功能。

## 注意事项

1. 确保模型配置中的系统提示词要求输出JSON格式
2. 模型返回的内容本质上仍是字符串，可能不是完整的JSON格式，需要流式解析
3. 在新格式下，`.env` 中的 `CLEAN_ASSISTANT_HISTORY` 配置将失去作用